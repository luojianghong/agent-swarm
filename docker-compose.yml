# Docker Compose for Agent Swarm
#
# Usage:
#   docker-compose --env-file .env up -d
#
# What it does:
#  - Sets up an API service and multiple worker/lead agents
#  - Deploys 2 worker agents and 1 lead agent by default
#  - Uses volumes for persistent storage of logs, db and agent workspaces

services:
  api:
    image: "ghcr.io/desplega-ai/agent-swarm:latest"
    pull_policy: always
    stop_grace_period: 60s

    environment:
      - API_KEY=${API_KEY}

      - MCP_BASE_URL=${MCP_BASE_URL}
      - APP_URL=${APP_URL}

      # Optional: Enable Slack integration
      - SLACK_DISABLE=${SLACK_DISABLE:-false}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - SLACK_APP_TOKEN=${SLACK_APP_TOKEN:-}

    ports:
      - "3013:3013"

    volumes:
      - swarm_api:/app

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3013/health || wget -q --spider http://localhost:3013/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: unless-stopped

  lead:
    image: "ghcr.io/desplega-ai/agent-swarm-worker:latest"
    pull_policy: always
    stop_grace_period: 60s

    depends_on:
      api:
        condition: service_healthy

    environment:
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}
      - API_KEY=${API_KEY}
      # Replace by a valid UUID
      - AGENT_ID=d454d1a5-4df9-49bd-8a89-e58d6a657dc3

      # Important: Lead agent role
      - AGENT_ROLE=lead

      # If in the same Docker network, use the service name
      - MCP_BASE_URL=http://api:3013

      - YOLO=true
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_EMAIL=${GITHUB_EMAIL:-}
      - GITHUB_NAME=${GITHUB_NAME:-}
      - SWARM_URL=${SWARM_URL:-localhost}

    ports:
      - "3020:3000"

    volumes:
      - swarm_logs:/logs
      - swarm_shared:/workspace/shared
      - swarm_lead:/workspace/personal

    restart: unless-stopped

  worker-1:
    image: "ghcr.io/desplega-ai/agent-swarm-worker:latest"
    pull_policy: always
    stop_grace_period: 60s

    depends_on:
      api:
        condition: service_healthy

    environment:
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}
      - API_KEY=${API_KEY}
      # Replace by a valid UUID - IMPORTANT: Keep stable for task resume after restarts
      - AGENT_ID=38d36438-58a0-45b5-8602-a5d52b07c2f1
      - AGENT_ROLE=worker

      # If in the same Docker network, use the service name
      - MCP_BASE_URL=http://api:3013

      - YOLO=true
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_EMAIL=${GITHUB_EMAIL:-}
      - GITHUB_NAME=${GITHUB_NAME:-}
      - SWARM_URL=${SWARM_URL:-localhost}

    ports:
      - "3021:3000"

    volumes:
      - swarm_logs:/logs
      - swarm_shared:/workspace/shared
      - swarm_worker_1:/workspace/personal

    restart: unless-stopped

  worker-2:
    image: "ghcr.io/desplega-ai/agent-swarm-worker:latest"
    pull_policy: always
    stop_grace_period: 60s

    depends_on:
      api:
        condition: service_healthy

    environment:
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}
      - API_KEY=${API_KEY}
      # Replace by a valid UUID - IMPORTANT: Keep stable for task resume after restarts
      - AGENT_ID=c1e2f3a4-5678-90ab-cdef-1234567890ab
      - AGENT_ROLE=worker

      # If in the same Docker network, use the service name
      - MCP_BASE_URL=http://api:3013

      - YOLO=true
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_EMAIL=${GITHUB_EMAIL:-}
      - GITHUB_NAME=${GITHUB_NAME:-}
      - SWARM_URL=${SWARM_URL:-localhost}

    ports:
      - "3022:3000"

    volumes:
      - swarm_logs:/logs
      - swarm_shared:/workspace/shared
      - swarm_worker_2:/workspace/personal

    restart: unless-stopped

volumes:
  swarm_api:
  swarm_logs:
  swarm_shared:
  swarm_lead:
  swarm_worker_1:
  swarm_worker_2:

